# Multi-App Logging with Single Azure OpenAI Instance -- Using Azure API Management

Included in the repo are the two python scripts to test the APIM-AOAI configuration for two different apps.

Also included is the main APIM policy and the accompanying policy fragments.

## The Event Hub Streaming Data

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/be37da04-4dbb-474f-9f56-1ab302f2fcf9)

## The APIM Logging Data

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/88045009-93c8-4a24-8e19-875ae05d2eed)

## How to Query Data in APIM Logs, including Token to Dollars Calculation

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/410e46bb-d909-4aea-b66a-b094cd3e537b)

## API Settings:  General, Subscription, Security

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/f68060fc-21ee-447c-82bc-0b85a17d8c98)

## API Settings:  Diagnostic Logs (Application Insights and Azure Monitor)

### Applications Insights

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/06b61d75-a959-4063-91e2-e866980a3c49)

### Azure Monitor

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/e6f1e629-ba08-4c03-bf0e-c37ce24168b0)

### APIM Policy

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/e81cc807-3722-49cd-80b3-bc6143c8a37e)

## Policy Fragments

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/6f932f9c-ba7e-4457-9883-d2bb6ab00aff)

## Subscription for Azure OpenAI

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/830b7fa1-75e0-4d2d-be65-3f8041788ddb)

## Access to Azure OpenAI Granted to APIM Instance

![image](https://github.com/blazekids4/apim-multiapp-logging/assets/45666337/402ee6c2-6b01-44ff-918d-57eecadfb9df)

## Some additional resources

- Smart load balancing for OpenAI endpoints and Azure API Management:  <https://github.com/andredewes/apim-aoai-smart-loadbalancing>
- Azure OpenAI APIM Enterprise Logging: <https://github.com/andredewes/apim-aoai-smart-loadbalancing>
- Open AI Cost Gateway Pattern:  <https://github.com/ThePreston/Custom-Rate-Limiter-API>
- Azure OpenAI Model Pricing (Pay-as-you-go):  <https://azure.microsoft.com/en-us/pricing/details/cognitive-services/openai-service/#pricing>
- Azure OpenAI Service quotas and limits:  <https://learn.microsoft.com/en-us/azure/ai-services/openai/quotas-limits>
